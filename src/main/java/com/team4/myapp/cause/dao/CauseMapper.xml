<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team4.myapp.cause.dao.ICauseRepository">

	<insert id="insertCause" parameterType="com.team4.myapp.cause.model.Cause">	
		INSERT INTO CAUSE(CAUSE_ID, CAUSE_CONTENT, CAUSE_STATUS, CATEGORY_ID, ATTENDANCE_ID, MEMBER_ID
			<if test="fileData != null">,FILE_DATA, FILE_NAME, FILE_SIZE, FILE_CONTENT_TYPE</if>
		) VALUES (
			cause_seq.nextval, #{content}, 0, #{categoryId}, #{attendanceId}, #{memberId}
			<if test="fileData != null">, #{fileData}, #{fileName}, #{fileSize}, #{fileContentType}</if>
		)	
	</insert>
	
	<select id="selectCauseCount" parameterType="string" resultType="int">
		<![CDATA[
			SELECT COUNT(*) AS "count" FROM CAUSE WHERE MEMBER_ID=#{memberId}
		]]> 
	</select>
	
	<select id="selectCount" resultType="int">
		<![CDATA[
			SELECT COUNT(*) AS count FROM CAUSE
		]]>
	</select> 
	
	<select id="selectCauseList" parameterType="map" resultType="com.team4.myapp.cause.model.dto.CauseListDto">
		<![CDATA[
			SELECT bb.CAUSE_ID 	AS		causeId,
	        		WRITE_DATE 	AS 		writeDate,
	        		CAUSE_CONTENT		AS 		content,
	        		CATEGORY_ID		AS 		categoryId,
	       			bb.MEMBER_ID		AS 	memberId,
	       		 	bb.ATTENDANCE_STATUS 	AS attendanceStatus,
	       			bb.CAUSE_STATUS 		AS 		causeStatus,
	        		RNUM+1 AS seq
					FROM( SELECT aa.CAUSE_ID, aa.WRITE_DATE, aa.CAUSE_CONTENT, CATEGORY_ID, aa.MEMBER_ID, ATTENDANCE_STATUS, CAUSE_STATUS, ROWNUM AS RNUM
	            		FROM (
	                		SELECT  CAUSE_ID, CAUSE.WRITE_DATE, CAUSE.CAUSE_CONTENT, CATEGORY_ID, CAUSE.MEMBER_ID, ATTENDANCE.ATTENDANCE_STATUS, CAUSE.CAUSE_STATUS
	                		FROM CAUSE, ATTENDANCE
	                		WHERE ATTENDANCE.ATTENDANCE_ID = CAUSE.ATTENDANCE_ID and CAUSE.MEMBER_ID = #{memberId}
	                		ORDER BY WRITE_DATE DESC
	                	) aa
	        		) bb
			WHERE RNUM BETWEEN #{start} AND #{end}
		]]>
	</select>
	
	<select id="selectCauseAdmin" resultType="com.team4.myapp.cause.model.dto.CauseListDto">
		<![CDATA[
				SELECT bb.CAUSE_ID 	AS	causeId,
	        		WRITE_DATE 	AS 		writeDate,
	        		CAUSE_CONTENT		AS 		content,
	        		CATEGORY_ID		AS 		categoryId,
	       			bb.MEMBER_ID		AS 	memberId,
                    bb.MEMBER_NAME		AS 		memberName,
	       		 	bb.ATTENDANCE_STATUS 	AS attendanceStatus,
	       			bb.CAUSE_STATUS 		AS 		causeStatus,
	        		RNUM+1 AS seq
					FROM( SELECT aa.CAUSE_ID, aa.WRITE_DATE, aa.CAUSE_CONTENT, CATEGORY_ID, aa.MEMBER_ID, aa.MEMBER_NAME, ATTENDANCE_STATUS, CAUSE_STATUS, ROWNUM AS RNUM
	            		FROM (
	                		SELECT  CAUSE_ID, CAUSE.WRITE_DATE, CAUSE.CAUSE_CONTENT, CATEGORY_ID, CAUSE.MEMBER_ID, MEMBERS.MEMBER_NAME, ATTENDANCE.ATTENDANCE_STATUS, CAUSE.CAUSE_STATUS
	                		FROM CAUSE, ATTENDANCE, MEMBERS
	                		WHERE ATTENDANCE.ATTENDANCE_ID = CAUSE.ATTENDANCE_ID AND CAUSE.MEMBER_ID = MEMBERS.MEMBER_ID
	                		ORDER BY WRITE_DATE DESC
	                	) aa
	        		) bb
			WHERE RNUM BETWEEN #{start} AND #{end}
		]]>
	</select>
	
	<select id="selectCauseDetail" parameterType="int" resultType="com.team4.myapp.cause.model.dto.CauseListDto">
		<![CDATA[
			SELECT 	CAUSE.CAUSE_ID 	AS	causeId,
					   WRITE_DATE 	AS 		writeDate,
					   CAUSE_CONTENT		AS 		content,
					   CAUSE.CATEGORY_ID		AS 		categoryId,
					   MEMBERS.MEMBER_ID		AS 	memberId,
				       MEMBER_NAME		AS 		memberName,
					   ATTENDANCE_STATUS 	AS attendanceStatus,
					   CAUSE_STATUS 		AS 		causeStatus,
					   FILE_SIZE AS fileSize,
					   FILE_CONTENT_TYPE AS fileContentType,
					   FILE_DATA 	AS 		fileData,
					   FILE_NAME AS fileName,
					   ATTENDANCE_DATE	AS attendanceDate
			FROM CAUSE, ATTENDANCE, MEMBERS 
			WHERE CAUSE.ATTENDANCE_ID = ATTENDANCE.ATTENDANCE_ID AND MEMBERS.MEMBER_ID = CAUSE.MEMBER_ID AND CAUSE.CAUSE_ID=#{causeId}
		]]>
	</select>
	
	<update id="updateCauseDetail" parameterType="int">
		<![CDATA[
			UPDATE CAUSE
				SET CAUSE_CONTENT AS causeContent, 
					FILE_NAME=#{fileName},
					FILE_SIZE=#{fileSize},
					FILE_CONTENT=#{fileContentType},
					FILE_DATA=#{fileData}
			WHERE CAUSE_ID=#{cause_id}
		]]>
	</update>
	
</mapper>